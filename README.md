# 中選會選舉資料統一處理系統（1996-2024）

本專案用於處理中華民國中央選舉委員會（CEC）的選舉開票資料，將1996-2024年原始CSV檔案轉換為統一格式，便於分析使用。

## 📋 專案概述

本系統自動處理1996-2024年的各類選舉資料，包括：
- 總統選舉（1996, 2012, 2016, 2020, 2024）
- 立法委員選舉（3屆-1998, 5屆-2004, 2016, 2020, 2024）
- 地方公職人員選舉（2010, 2014, 2018, 2022）
- 五都選舉（2010）

### 特色功能
✅ **自動格式檢測** - 支援三種CSV格式（無引號、帶'前綴、標準引號）  
✅ **智慧聚合** - 自動去重並正確加總票數（整數票數、無重複投開票所）  
✅ **統一命名** - `{年份}_{選舉類型}_{縣市}.csv`  
✅ **縣市代碼映射** - 自動將原始代碼轉換為正確縣市名稱  
✅ **省名稱清理** - 自動移除「臺灣省」、「福建省」等歷史行政區劃  
✅ **選區候選人過濾** - 每個選區只顯示該選區的候選人  
✅ **統計欄位自動計算** - 自動計算有效票數、投票率、用餘票數等統計數據  
✅ **縣市資料合併** - 自動產生每個縣市的完整合併檔案（{縣市}_選舉整理_完成版.csv）  
✅ **候選人資料完整** - 保留候選人姓名、政黨、得票數、得票率等完整資訊  
✅ **全國21縣市** - 涵蓋所有直轄市、縣市，共127,587筆選舉紀錄

## 🎯 資料處理邏輯

### 資料分割規則

#### 1. 依選舉類型分割

所有選舉資料按選舉類型分為獨立檔案：

- **總統選舉**：不分選區，一個縣市一個檔案
- **縣市長/鄉鎮市長**：不分選區，一個縣市一個檔案
- **立法委員**：按選區分割，每個選區一個檔案
- **縣市議員**：按選區分割，每個選區一個檔案
- **鄉鎮市民代表**：按選區分割，每個選區一個檔案

#### 2. 選區分類

- **區域選舉**：`{年份}_{選舉類型}_區域_第{XX}選區_{縣市}.csv`
- **平地原住民**：`{年份}_{選舉類型}_平地原住民_第{XX}選區_{縣市}.csv`
- **山地原住民**：`{年份}_{選舉類型}_山地原住民_第{XX}選區_{縣市}.csv`

#### 3. 候選人編號處理

- **原始格式**：`1_候選人姓名`（包含號次前綴）
- **輸出格式**：`候選人姓名`（移除號次前綴，避免欄位名稱重複）
- **原因**：確保不同年份資料合併時，候選人欄位能正確對應

### 資料彙總層級

#### 有投開票所別的選舉（立委、議員）

- **原始層級**：投開票所層級
- **輸出層級**：投開票所層級（保留明細）
- **檔名格式**：`{年份}_{選舉類型}_第{XX}選區_{縣市}.csv`
- **範例**：`2020_立法委員_第01選區_臺北市.csv`
- **欄位**：包含 `投開票所別` 欄位

#### 沒有投開票所別的選舉（總統、縣市長、鄉鎮市長）

- **原始層級**：村里層級
- **輸出層級**：村里層級
- **檔名格式**：`{年份}_{選舉類型}_{縣市}.csv`
- **範例**：`2020_總統_臺北市.csv`
- **欄位**：不包含 `投開票所別` 欄位

### 縣市合併邏輯

每個縣市會產生一個 `{縣市}_選舉整理_完成版.csv` 合併檔案，合併流程如下：

#### 第一階段：讀取與格式化

```text
對每個 CSV 檔案：
  1. 讀取檔案
  2. 從檔名提取資訊（年份、選舉類型、選區）
  3. 新增欄位：時間、選舉名稱、縣市、行政區別、選區
  4. 立即格式化為標準欄位（選舉候選人1, 選舉候選人2, ...）
     → 關鍵：確保不同年份的候選人欄位統一命名
```

#### 第二階段：分離處理

```text
將所有檔案分為兩類：
  
  A. 有投開票所別的資料（立委、議員）
     - 聚合到村里層級
     - 方法：groupby(['時間','選舉名稱','縣市','行政區別','村里別','選區']).sum()
     - 結果：每個村里的所有投開票所票數加總
  
  B. 沒有投開票所別的資料（總統、縣市長、鄉鎮市長）
     - 只去重，不聚合
     - 方法：drop_duplicates(subset=['時間','選舉名稱','行政區別','村里別'])
     - 結果：保留原始村里層級資料
```

#### 第三階段：合併輸出

```text
合併 A + B：
  - 使用 pd.concat() 縱向合併
  - 直接輸出（已在第一階段完成格式化）
  - 不需要再次調用 reformat_to_standard_columns
```

### 關鍵設計決策

#### 為何要在讀取時立即格式化？

**問題**：不同年份的總統選舉候選人不同

- 2020年：`1_宋楚瑜/余湘`, `2_韓國瑜/張善政`, `3_蔡英文/賴清德`
- 2024年：`1_柯文哲/吳欣盈`, `2_賴清德/蕭美琴`, `3_侯友宜/趙少康`

**舊方法（錯誤）**：

```text
concat(2020, 2024) → 產生6個候選人欄位（每年3個）
聚合時無法正確處理 → 候選人資料混亂
```

**新方法（正確）**：

```text
格式化2020 → 選舉候選人1, 選舉候選人2, 選舉候選人3
格式化2024 → 選舉候選人1, 選舉候選人2, 選舉候選人3
concat → 只有3個候選人欄位（統一命名）
聚合 → 正確處理
```

#### 為何要分離有/無投開票所別的資料？

**問題**：concat 混合 schema 導致資料丟失

```text
有投開票所別的檔案：[時間, 選舉名稱, ..., 投開票所別, 候選人票數]
沒有投開票所別的檔案：[時間, 選舉名稱, ..., 候選人票數]

concat → 投開票所別欄位產生（沒有的填 NaN）
groupby(包含投開票所別) → 自動排除 NaN → 總統資料消失 ❌
```

**解決方案**：分離處理

```text
有投開票所別 → 聚合（需要加總投開票所）
沒有投開票所別 → 去重（已是村里層級）
最後合併 → 所有資料保留 ✓
```


## 📁 資料夾結構

```
CEC_data_clearn_and_combine/
├── 各縣市候選人分類/
│   └── votedata/
│       └── voteData/               # 原始中選會資料
│           ├── 9任總統/
│           ├── 3屆立委/
│           ├── 2020總統立委/
│           ├── 2022-111年地方公職人員選舉/
│           └── ...
├── 全國各種選舉資料整理/            # 處理後輸出（依縣市分資料夾）
│   ├── 臺北市/
│   │   ├── 1996_總統_臺北市.csv
│   │   ├── 2020_總統_臺北市.csv
│   │   ├── 2020_立法委員_第01選區_臺北市.csv
│   │   ├── 2020_立法委員_山地原住民_臺北市.csv
│   │   ├── ...
│   │   └── 臺北市_選舉整理_完成版.csv  # 該縣市所有資料合併檔案
│   ├── 高雄市/
│   └── ... (共21個縣市)
├── processors/                     # 資料處理模組
│   ├── __init__.py                 # 模組初始化（導出主要類別）
│   └── process_election_unified.py # 統一處理器（UnifiedElectionProcessor）
├── utils/                          # 工具函數（預留）
│   └── __init__.py
├── main.py                         # 主程式入口
├── correctness_test.py                     # 整合測試腳本
└── README.md                       # 本說明文件
```

## 🚀 使用方式

### 1. 環境準備
```bash
# 安裝依賴套件
pip install pandas openpyxl
```

### 2. 執行處理

#### 處理所有年份
```bash
python3 main.py
```

#### 測試CSV格式檢測
```bash
python3 main.py test
```

#### 處理指定年份
```bash
# 處理2020年資料
python3 main.py --year 2020

# 可用年份：1996, 1998, 2004, 2010, 2010_5du, 2012, 2014, 2016, 2018, 2020, 2022, 2024
```

### 3. 執行驗證測試

本系統包含整合測試腳本 `correctness_test.py`，用於驗證處理後的資料品質。

#### 測試所有縣市

```bash
python3 correctness_test.py
```

輸出範例：
```
找到 21 個縣市的合併資料檔案
[1/21] 測試 南投縣... ✅
[2/21] 測試 嘉義市... ✅
...
總計: 21 個縣市
  ✅ 完全正常: 21 個 (100.0%)
```

#### 測試指定縣市

```bash
python3 correctness_test.py --county 南投縣
```

#### 查看詳細報告

```bash
python3 correctness_test.py --detail 臺北市
```

#### 指定自訂資料目錄

```bash
python3 correctness_test.py --dir /path/to/your/data
```

### 4. 讀取處理後的資料

```python
import pandas as pd

# 讀取總統選舉資料（村里層級）
df_president = pd.read_csv('全國各種選舉資料整理/臺北市/2020_總統_臺北市.csv', encoding='utf-8-sig')

# 讀取立委選舉資料（投開票所層級）
df_legislator = pd.read_csv('全國各種選舉資料整理/臺北市/2020_立法委員_第01選區_臺北市.csv', encoding='utf-8-sig')

print(f"總統選舉村里數: {len(df_president)}")
print(f"立委選舉投開票所數: {len(df_legislator)}")
```

## 📊 資料欄位說明

### 個別選舉檔案欄位

#### 總統選舉欄位

```csv
行政區別, 村里別,
1_柯文哲/吳欣盈, 2_賴清德/蕭美琴, 3_侯友宜/趙少康,
有效票數A, 無效票數B, 投票數C, 已領未投票數D,
發出票數E, 用餘票數F, 選舉人數G, 投票率H
```

#### 立委/議員選舉欄位

```csv
行政區別, 村里別, 投開票所別,
1_候選人A, 2_候選人B, 3_候選人C, ...,
有效票數A, 無效票數B, 投票數C, 已領未投票數D,
發出票數E, 用餘票數F, 選舉人數G, 投票率H
```

### 合併檔案欄位格式

縣市合併檔案（`{縣市}_選舉整理_完成版.csv`）使用標準化欄位格式：

```csv
時間, 選舉名稱, 縣市, 區域代碼, 選區, 行政區別, 村里別,
選舉候選人1, 選舉候選人政黨1, 選舉候選人得票數1, 選舉候選人得票率1,
選舉候選人2, 選舉候選人政黨2, 選舉候選人得票數2, 選舉候選人得票率2,
選舉候選人3, 選舉候選人政黨3, 選舉候選人得票數3, 選舉候選人得票率3,
...(最多30組候選人欄位),
有效票數, 無效票數, 投票數, 已領未投票數,
發出票數, 用餘票數, 選舉人數, 投票率, 立委選區
```

**欄位說明**：

- `時間`：選舉年份（2020, 2024等）
- `選舉名稱`：總統、立法委員、縣市議員、縣市長、鄉鎮市長、鄉鎮市民代表
- `縣市`：縣市名稱
- `區域代碼`：選區代碼（如有）
- `選區`：第01選區、山地原住民、平地原住民等
- `行政區別`：鄉鎮市區名稱
- `村里別`：村里名稱
- `選舉候選人{N}`：候選人姓名（已移除號次前綴）
- `選舉候選人政黨{N}`：候選人政黨（目前為空）
- `選舉候選人得票數{N}`：候選人得票數
- `選舉候選人得票率{N}`：候選人得票率（0-1之間的小數）
- 統計欄位已標準化（移除A/B/C等後綴）

### 候選人欄位格式

**個別檔案**：

- **總統**：`1_柯文哲/吳欣盈`, `2_賴清德/蕭美琴`（保留號次前綴）
- **其他**：`1_陳源奇`, `2_魏耀乾`（保留號次前綴）

**合併檔案**：

- **所有選舉**：`選舉候選人1`, `選舉候選人2`（統一標準化欄位名稱）
- 候選人姓名已移除號次前綴，直接顯示姓名

## 🔧 技術特點

### 1. CSV格式自動檢測
系統自動處理三種CSV格式：
- **舊格式（無引號）**：`00,000,00,000,0000,全國`
- **引號格式（帶'前綴）**：`"'00","'000","'00","'000","'0000","全國"`
- **引號格式（無'前綴）**：`"63","000","00","000","0000","臺北市"`

### 2. 智慧資料聚合
- 使用 `groupby` + `sum` 聚合，確保：
  - ✅ 票數為整數（無小數點）
  - ✅ 每個投開票所唯一（無重複行）
  - ✅ 票數正確加總

### 3. 多編碼支援
自動嘗試多種編碼：`utf-8`, `big5`, `cp950`, `gb18030`

### 4. 效能優化
- 使用字典查詢地區名稱（替代iterrows）
- 大型資料集處理時間：1-5分鐘

## 📈 已處理資料統計

### 處理完成年份
| 年份 | 選舉類型 | 狀態 |
|------|---------|------|
| 1996 | 9任總統 | ✅ |
| 1998 | 3屆立委 | ✅ |
| 2004 | 5屆立委 | ✅ |
| 2010 | 鄉鎮市民代表 | ✅ |
| 2010 | 五都選舉 | ✅ |
| 2012 | 總統立委 | ✅ |
| 2014 | 地方公職 | ✅ |
| 2016 | 總統立委 | 🚧 待實作合併 |
| 2018 | 地方公職 | ✅ |
| 2020 | 總統立委 | ✅ |
| 2022 | 地方公職 | 🚧 待實作代碼系統 |
| 2024 | 總統立委 | ✅（區域立委檔案有誤）|

### 輸出統計
- **總檔案數**：490個CSV檔案
- **涵蓋縣市**：11個縣市（臺北市、新北市、桃園市、臺中市、臺南市、高雄市、基隆市、新竹市、嘉義市、宜蘭縣、連江縣）
- **資料年份**：1996-2024年（28年）
- **票數格式**：整數（已修正小數點問題）
- **投開票所**：無重複（每個投開票所只出現一次）

## ⚠️ 已知問題

### 1. 2024區域立委檔案錯誤
- **問題**：原始資料檔名為 `elbese.csv` 而非 `elbase.csv`
- **影響**：2024區域立委無法處理
- **解決方案**：需聯繫資料來源修正或手動重命名

### 2. 原住民立委資料（3/5屆）
- **問題**：原始資料沒有投開票所層級明細
- **狀態**：已輸出但資料筆數較少

### 3. 發出票數/選舉人數
- **問題**：部分年份原始資料這些欄位為0
- **影響**：投票率計算為0
- **說明**：這是原始資料的問題，非處理錯誤

## 📝 待完成功能

### 高優先級
- [ ] 實作2022代碼系統處理器（C1, D1, T1等代碼）
- [ ] 實作2016資料合併邏輯（old + new folders）

### 中優先級
- [ ] 處理2024區域立委檔案錯誤
- [ ] 完整測試所有年份輸出
- [ ] 驗證格式符合範例

## 📖 詳細文件

詳細技術文件請參考：[統一處理系統說明.md](統一處理系統說明.md)

內容包括：
- 完整資料格式分類
- 實現架構設計
- 處理邏輯詳解
- 已知問題與限制
- 技術細節

## 💡 使用案例

### 1. 讀取縣市合併檔案

```python
import pandas as pd

# 讀取縣市完整合併檔案
df = pd.read_csv('全國各種選舉資料整理/南投縣/南投縣_選舉整理_完成版.csv', encoding='utf-8-sig')

print(f"總筆數: {len(df)}")
print(f"選舉名稱: {sorted(df['選舉名稱'].unique())}")
print(f"\n各選舉筆數:")
print(df['選舉名稱'].value_counts().sort_index())

# 篩選2024總統選舉
president_2024 = df[(df['選舉名稱'] == '總統') & (df['時間'] == 2024)]
print(f"\n2024總統選舉村里數: {len(president_2024)}")

# 查看候選人得票
for i in range(1, 4):
    name_col = f'選舉候選人{i}'
    vote_col = f'選舉候選人得票數{i}'
    total = president_2024[vote_col].sum()
    if total > 0:
        print(f"{president_2024[name_col].iloc[0]}: {total:,} 票")
```

### 2. 分析2020總統選舉結果

```python
import pandas as pd

# 讀取臺北市總統選舉資料
df = pd.read_csv('全國各種選舉資料整理/臺北市/2020_總統_臺北市.csv', encoding='utf-8-sig')

# 查看前幾筆
print(df.head())

# 計算各候選人總得票
for col in df.columns:
    if col.startswith('1_') or col.startswith('2_') or col.startswith('3_'):
        print(f"{col}: {df[col].sum():,} 票")
```

### 3. 比較不同年份的投票趨勢

```python
# 使用合併檔案比較多年總統選舉
df = pd.read_csv('全國各種選舉資料整理/臺北市/臺北市_選舉整理_完成版.csv', encoding='utf-8-sig')

# 篩選總統選舉
president = df[df['選舉名稱'] == '總統']

# 比較各年份投票率
for year in sorted(president['時間'].unique()):
    year_data = president[president['時間'] == year]
    avg_turnout = year_data['投票率'].mean()
    print(f"{year}年投票率: {avg_turnout:.2f}%")
```

### 4. 分析投開票所層級資料

```python
# 讀取立委選舉投開票所明細
df = pd.read_csv('全國各種選舉資料整理/臺北市/2020_立法委員_第01選區_臺北市.csv', encoding='utf-8-sig')

# 統計各村里的投開票所數量
polling_count = df.groupby('村里別').size()
print(polling_count)

# 找出投票率最高的投開票所
top_turnout = df.nlargest(10, '投票率H')[['行政區別', '村里別', '投開票所別', '投票率H']]
print(top_turnout)
```

### 5. 分析合併檔案中的選區資料

```python
# 讀取合併檔案
df = pd.read_csv('全國各種選舉資料整理/臺北市/臺北市_選舉整理_完成版.csv', encoding='utf-8-sig')

# 分析2020立委選舉各選區結果
legislator_2020 = df[(df['選舉名稱'] == '立法委員') & (df['時間'] == 2020)]

# 統計各選區村里數
district_count = legislator_2020.groupby('選區').size()
print("各選區村里數:")
print(district_count)

# 分析特定選區的候選人得票
district_1 = legislator_2020[legislator_2020['選區'] == '第01選區']
for i in range(1, 11):  # 最多檢查10位候選人
    vote_col = f'選舉候選人得票數{i}'
    if vote_col in district_1.columns:
        total = district_1[vote_col].sum()
        if total > 0:
            name = district_1[f'選舉候選人{i}'].iloc[0]
            print(f"{name}: {total:,} 票")
```

## 🤝 貢獻指南

歡迎提交Issue或Pull Request改進本專案。

## 📄 授權

本專案為開源專案，資料來源為中華民國中央選舉委員會公開資料。

## 📧 聯絡方式

如有問題或建議，請透過GitHub Issues聯繫。

---

**最後更新**：2025-12-07  
**系統版本**：UnifiedElectionProcessor v2.3  
**處理檔案數**：21個縣市，127,587筆選舉紀錄  
**合併檔案**：每個縣市額外產生1個完整合併檔案（{縣市}_選舉整理_完成版.csv）  
**輸出資料夾**：全國各種選舉資料整理/  
**代碼結構**：模組化架構（processors/, utils/）

## 📝 更新歷史

### v2.3 (2025-12-07)

- ✅ **代碼結構重組** - 改善專案組織與維護性
  - 將 `process_election_unified.py` 移至 `processors/` 資料夾
  - 刪除未使用的舊模組：`data_processor.py`, `data_consolidator.py`, `regional_codes.py`, `schemas.py`
  - 更新 `main.py` 導入路徑：`from processors.process_election_unified import UnifiedElectionProcessor`
  - 配置 `processors/__init__.py` 正確導出模組
  - 清理 `utils/__init__.py`（保留供未來使用）
  - 移除約1100行不再使用的舊代碼
- ✅ **輸出資料夾重新命名** - 從 `processed_data_unified/` 改為 `全國各種選舉資料整理/`
- ✅ **測試框架整合** - 創建 `all_test.py` 整合所有驗證測試
  - 自動測試21個縣市的資料完整性
  - 驗證候選人資料、統計數據、格式一致性
  - 100% 測試通過率
- ✅ **更新文件** - README.md 反映新的代碼結構和資料夾名稱

### v2.2 (2025-12-06)

- ✅ **修正總統選舉合併邏輯** - 解決不同年份候選人資料遺失問題
  - 在讀取檔案時立即格式化為標準欄位（選舉候選人1, 選舉候選人2...）
  - 確保不同年份的候選人欄位統一命名，避免 concat 時產生重複欄位
  - 修正合併流程：格式化 → 分離處理 → 合併輸出
- ✅ **分離有/無投開票所別資料處理** - 防止資料丟失
  - 有投開票所別（立委、議員）：聚合到村里層級
  - 沒有投開票所別（總統、縣市長）：只去重不聚合
  - 避免 groupby 時過濾掉 NaN 值導致總統資料消失
- ✅ **立委選舉按選區分割** - 與議員選舉規則一致
  - 立委選舉改為每個選區獨立檔案
  - 檔名格式：`{年份}_立法委員_第{XX}選區_{縣市}.csv`
  - 包含原住民選區：平地原住民、山地原住民
- ✅ **移除候選人編號前綴** - 避免欄位名稱重複
  - 個別檔案保留：`1_候選人姓名`
  - 合併檔案移除：`候選人姓名` → 標準欄位 `選舉候選人1`

### v2.1 (2025-12-06)

- ✅ **統計欄位自動計算功能** - 修正elprof欄位映射，正確計算投票率、用餘票數等統計數據
  - 修正選舉人數G欄位映射（col 9）
  - 自動計算：發出票數E、用餘票數F = G - E、投票率H = C/G*100
  - 確保所有票數為整數，投票率正確顯示百分比
- ✅ **縣市資料合併功能** - 自動產生每個縣市的完整合併檔案
  - 合併該縣市所有年份、所有選舉類型的資料
  - 自動新增「時間」、「選舉名稱」、「縣市」、「選區」欄位
  - 智慧去重：以時間+選舉名稱+選區+行政區別+村里別為鍵值去除重複資料
  - 輸出檔名：`{縣市}_選舉整理_完成版.csv`
- ✅ 更新main.py整合新功能

### v2.0 (2025-12-06)

- ✅ 移除省名稱（臺灣省、福建省）
- ✅ 修正縣市代碼映射（南竿鄉→連江縣，宜蘭市→宜蘭縣）
- ✅ 修正選區候選人過濾（每個選區只顯示該選區的候選人）
- ✅ 修正票數小數點問題（所有票數為整數）
- ✅ 修正投開票所重複問題（每個投開票所只出現一次）
- ✅ 行政區別欄位包含選區編號

### v1.0 (2025-12-05)

- ✅ 建立統一處理架構
- ✅ 支援三種CSV格式自動檢測
- ✅ 實作智慧資料聚合
