# 中選會選舉資料處理系統

本專案用於處理中華民國中央選舉委員會（CEC）的選舉開票資料，將原始CSV檔案轉換為易於分析的格式。

## 📋 專案概述

本系統自動處理2014-2024年的各類選舉資料，包括：
- 總統選舉
- 立法委員選舉（區域、山地原住民、平地原住民）
- 直轄市議員選舉
- 非直轄市議員選舉
- 直轄市長/縣市長選舉

## 🎯 主要功能

### 1. 資料彙總層級
- **總統/市長選舉**：彙總至**村里層級**（同村里的所有投開票所票數加總）
- **議員/立委選舉**：保留**投開票所層級**明細（每個投開票所獨立一筆）

### 2. 檔案分類輸出

#### 總統/市長選舉
- **檔名格式**：`{年份}_{選舉類型}.csv`
- **範例**：`2024_總統.csv`、`2018_直轄市長.csv`
- **資料層級**：村里彙總（一個村里一筆）

#### 議員選舉（一般）
- **檔名格式**：`{年份}_{選舉類型}_第{選區編號}選區.csv`
- **範例**：`2022_直轄市議員_第01選區.csv`
- **資料層級**：投開票所明細
- **分檔方式**：一個選區一個檔案

#### 原住民立委/議員
- **檔名格式**：`{年份}_{選舉類型}_{原住民類型}.csv`
- **範例**：`2024_立法委員_山地原住民.csv`、`2024_立法委員_平地原住民.csv`
- **資料層級**：投開票所明細
- **分檔方式**：不分選區，全縣市合併為一個檔案

### 3. 資料欄位說明

#### 總統選舉欄位
```
縣市代碼, 鄉鎮市區代碼, 村里代碼, 行政區別, 村里別, 
{號次}_{候選人姓名}/{副手姓名}, ...,
有效票數A, 無效票數B, 投票數C, 已領未投票數D, 
發出票數E, 用餘票數F, 選舉人數G, 投票率H
```

#### 議員/立委選舉欄位
```
行政區別, 村里別, 投開票所別,
{號次}_{候選人姓名}, ...,
有效票數A, 無效票數B, 投票數C, 已領未投票數D,
發出票數E, 用餘票數F, 選舉人數G, 投票率H
```

### 4. 候選人欄位格式
- **格式**：`{號次}_{候選人姓名}`或`{號次}_{正職姓名}/{副職姓名}`
- **範例**：
  - 總統：`1_朱立倫/王如玄`、`2_蔡英文/陳建仁`
  - 議員：`1_王小明`、`2_李大華`
- **用途**：號次前綴確保不同縣市的候選人欄位可以正確對齊合併

## 📁 資料夾結構

```
專案根目錄/
├── voteData/              # 原始中選會資料
│   └── voteData/          # 各年度選舉資料
├── {縣市名稱}/            # 處理後的輸出資料（依縣市分資料夾）
│   ├── 2016_總統.csv
│   ├── 2022_直轄市議員_第01選區.csv
│   ├── 2022_直轄市議員_第02選區.csv
│   ├── 2024_立法委員_第01選區.csv
│   ├── 2024_立法委員_山地原住民.csv
│   └── ...
├── cec_data_processor.py  # 主要處理程式
├── requirements.txt       # Python套件依賴
└── README.md             # 本說明文件
```

## 🚀 使用方式

### 1. 安裝依賴套件
```bash
pip install -r requirements.txt
```

### 2. 執行資料處理
```bash
python cec_data_processor.py
```

處理完成後，資料將輸出到各縣市資料夾中。

### 3. 讀取處理後的資料
```python
import pandas as pd

# 讀取總統選舉資料（村里層級）
df_president = pd.read_csv('臺北市/2024_總統.csv', encoding='utf-8-sig')

# 讀取議員選舉資料（投開票所層級）
df_council = pd.read_csv('臺北市/2022_直轄市議員_第01選區.csv', encoding='utf-8-sig')

# 讀取原住民立委資料（投開票所層級，全縣市）
df_indigenous = pd.read_csv('臺北市/2024_立法委員_山地原住民.csv', encoding='utf-8-sig')
```

## 📊 資料處理邏輯

### 彙總規則

#### 總統/市長選舉
1. 原始資料：投開票所層級（每個投開票所一筆）
2. 處理邏輯：依`[縣市, 鄉鎮區, 村里]`分組，將同村里的所有投開票所票數**加總**
3. 輸出結果：每個村里只有一筆資料
4. 用途：適合進行村里層級的分析，避免資料過於龐大

#### 議員/立委選舉
1. 原始資料：投開票所層級
2. 處理邏輯：**保留**每個投開票所的原始資料，不進行彙總
3. 輸出結果：每個投開票所獨立一筆
4. 用途：
   - 精細分析各投開票所的投票行為
   - 偵測異常投票模式
   - 研究同一村里內不同投開票所的差異

### 選區分檔邏輯

#### 一般議員
- **判斷依據**：`GroupCode`欄位（選區代碼）
- **轉換方式**：`'010'` → 第01選區、`'020'` → 第02選區
- **輸出方式**：每個選區獨立一個CSV檔案
- **原因**：
  - 不同選區的候選人不同
  - 分檔後更易於分析特定選區
  - 檔案大小適中，便於開啟編輯

#### 原住民立委/議員
- **判斷依據**：資料夾名稱包含「山地」或「平地」
- **輸出方式**：全縣市合併為一個檔案（山地、平地分開）
- **原因**：
  - 原住民選舉不分選區，全縣市為一個選區
  - 保持資料完整性

### 總計行邏輯

每個輸出檔案包含：
1. **全市總計**：所有行政區的加總（第一行）
2. **各行政區總計**：每個鄉鎮市區的小計
3. **各村里明細**：實際投票資料

## ⚠️ 注意事項

### 資料特性
1. **村里代碼唯一性**：總統選舉包含`縣市代碼`、`鄉鎮市區代碼`、`村里代碼`三個欄位，確保全國同名村里可區分
2. **候選人號次**：候選人欄位前綴號次（如`1_候選人`），確保不同縣市資料可正確合併
3. **投開票所代碼**：議員/立委資料的`投開票所別`欄位為4位數字（如`0001`、`0002`）

### 檔案編碼
所有輸出檔案使用 **UTF-8-BOM** 編碼（`utf-8-sig`），確保Excel正確顯示中文。

### 資料完整性
- 自動過濾無效資料（如LiCode='0000'的彙總資料）
- 自動過濾跨區資料（如GroupCode='000'）
- 保留原始縣市代碼以便追溯

## 🔧 技術細節

### 處理流程
1. **讀取原始資料**：
   - `elbase.csv`：行政區域代碼對照表
   - `elcand.csv`：候選人資料
   - `elctks.csv`：各投開票所得票數
   - `elprof.csv`：投票統計資料

2. **資料清理**：
   - 移除無效資料
   - 數值欄位轉換
   - 處理引號和特殊字元

3. **彙總/保留**（依選舉類型）：
   - 總統/市長：彙總到村里層級
   - 議員/立委：保留投開票所層級

4. **格式化輸出**：
   - 轉換為寬格式（每個候選人一欄）
   - 添加總計行
   - 計算投票率等衍生欄位

5. **分檔輸出**：
   - 依縣市建立資料夾
   - 依選舉類型和選區分檔

### 關鍵函數
- `process_election_data()`：處理單一選舉資料夾
- `add_summary_rows()`：添加總計行
- `format_output()`：格式化輸出欄位
- `process_year()`：處理整年度所有選舉

## 📈 使用案例

### 1. 分析某村里的總統選舉投票趨勢
```python
import pandas as pd

# 讀取2016和2024年總統資料
df_2016 = pd.read_csv('臺北市/2016_總統.csv', encoding='utf-8-sig')
df_2024 = pd.read_csv('臺北市/2024_總統.csv', encoding='utf-8-sig')

# 篩選特定村里
village_2016 = df_2016[df_2016['村里別'] == '中正里']
village_2024 = df_2024[df_2024['村里別'] == '中正里']

# 比較候選人得票
print(village_2016[['村里別', '1_朱立倫/王如玄', '2_蔡英文/陳建仁']])
print(village_2024[['村里別', '1_侯友宜/趙少康', '2_賴清德/蕭美琴', '3_柯文哲/吳欣盈']])
```

### 2. 分析某選區議員選舉的投開票所分布
```python
# 讀取議員選舉資料（含投開票所明細）
df_council = pd.read_csv('臺北市/2022_直轄市議員_第01選區.csv', encoding='utf-8-sig')

# 統計各投開票所的投票人數
polling_stats = df_council.groupby('投開票所別')['投票數C'].sum()
print(polling_stats)

# 找出投票率最高的投開票所
df_council['投票率H'] = pd.to_numeric(df_council['投票率H'])
top_turnout = df_council.nlargest(10, '投票率H')[['村里別', '投開票所別', '投票率H']]
print(top_turnout)
```

### 3. 合併多個縣市的資料
```python
import pandas as pd
from pathlib import Path

# 合併所有縣市的2024總統選舉資料
all_president_2024 = []
for city_folder in Path('.').iterdir():
    if city_folder.is_dir():
        file_path = city_folder / '2024_總統.csv'
        if file_path.exists():
            df = pd.read_csv(file_path, encoding='utf-8-sig')
            all_president_2024.append(df)

# 合併為全國資料
df_national = pd.concat(all_president_2024, ignore_index=True)
print(f'全國村里數: {len(df_national)}')
```

## 📝 版本歷史

### v2.0 (2024-12-04)
- ✅ 總統/市長選舉彙總至村里層級（避免重複村里）
- ✅ 議員/立委保留投開票所層級明細
- ✅ 一般議員按選區分檔輸出
- ✅ 原住民立委/議員不分選區（全縣市一個檔案）
- ✅ 新增投開票所別欄位（議員/立委）
- ✅ 修正候選人欄位格式（加入號次前綴）
- ✅ 完善README文件

### v1.0 (2024-12)
- 初始版本，基本資料處理功能

## 🤝 貢獻指南

歡迎提交Issue或Pull Request改進本專案。

## 📄 授權

本專案為開源專案，資料來源為中華民國中央選舉委員會公開資料。

## 📧 聯絡方式

如有問題或建議，請透過GitHub Issues聯繫。
