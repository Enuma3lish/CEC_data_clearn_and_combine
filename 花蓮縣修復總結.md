# 花蓮縣選舉資料修復總結

## 修復日期
2024年12月 (具體日期根據實際情況填寫)

## 修復內容

### 1. 統計欄位錯誤修復 ✅
**問題**: 
- 區域立委選舉人數G = 0
- 總統候選人投票數C 錯誤

**原因**:
- 立委資料未正確讀取 elprof.csv 統計檔案
- 總統資料的 elprof.csv 欄位對應錯誤

**解決方案**:
1. 修改 `repair_legislator_data()` 從 elprof.csv 讀取統計
2. 修正總統 elprof.csv 的欄位對應:
   - Column 6 → 有效票數A
   - Column 7 → 無效票數B  
   - Column 8 → 投票數C
   - Column 9 → 選舉人數G
   - Column 10 → 已領未投票數D
   - Column 11 → 發出票數E
   - Column 16 → 用餘票數F
   - Column 17 → 投票率H

### 2. 候選人資料缺失修復 ✅
**問題**:
- 2016年缺少 楊悟空
- 2020年缺少所有區域立委候選人
- 2024年缺少所有區域立委候選人

**原因**:
使用 city_code = -1 選擇了全省資料而非花蓮縣

**解決方案**:
將 main.py 第 826-834 行的 city_code 從 -1 改為 15

```python
repair_president_data("花蓮縣", 2016, "2016_總統.csv", 10, 15)  # 改為 15
repair_legislator_data("花蓮縣", 2016, 10, 15)  # 改為 15
repair_president_data("花蓮縣", 2020, "2020_總統.csv", 10, 15)  # 改為 15  
repair_legislator_data("花蓮縣", 2020, 10, 15)  # 改為 15
repair_president_data("花蓮縣", 2024, "2024_總統.csv", 10, 15)  # 改為 15
repair_legislator_data("花蓮縣", 2024, 10, 15)  # 改為 15
```

### 3. 總統資料格式修復 ✅
**問題**:
最終輸出檔案的總統候選人欄位錯位

**原因**:
- `repair_president_data()` 輸出標準格式 (候選人X＿候選人名稱)
- `format_converter.py` 的 `format_generic_data()` 只能處理 pivot 格式

**解決方案**:
在 `format_converter.py` 的 `format_generic_data()` 函數中添加格式檢測:
- 檢測是否為標準格式 (包含 "候選人X＿候選人名稱" 欄位)
- 針對標準格式和 pivot 格式使用不同的處理邏輯

### 4. 總統資料來源檔案缺失修復 ✅
**問題**:
總統資料夾沒有 villmap.csv 和 distmap.csv

**解決方案**:
修改 `repair_president_data()` 從 elbase.csv 建立地名映射:
- 讀取 elbase.csv
- 當 li_code = "0000" 時,建立 dist_map (行政區名稱)
- 當 li_code != "0000" 時,建立 village_map (村里名稱)

### 5. 總統統計資料聚合修復 ✅  
**問題**:
總統 elprof.csv 包含 514 筆投開票所層級的資料,需要聚合到 176 個村里

**解決方案**:
在 `repair_president_data()` 中添加聚合邏輯:
```python
stat_agg = df_prof.groupby(['行政區別', '村里別'], as_index=False).agg({
    '有效票數A': 'sum',
    '無效票數B': 'sum',
    '投票數C': 'sum',
    '選舉人數G': 'sum',
    '已領未投票數D': 'sum',
    '發出票數E': 'sum',
    '用餘票數F': 'sum',
    '投票率H': 'max'  # 投票率使用最大值
})
```

## 修復後的驗證結果

### 2020 年花蓮縣選舉資料 (範例: 光復鄉北富村)
- ✅ 總統候選人: 3 位 (宋楚瑜/余湘, 韓國瑜/張善政, 蔡英文/賴清德)
- ✅ 總統候選人有效票數A: 1144
- ✅ 總統候選人無效票數B: 6
- ✅ 總統候選人投票數C: 1150
- ✅ 總統候選人選舉人數G: 已從區域立委共享
- ✅ 統計公式: A + B = C (1144 + 6 = 1150) ✓
- ✅ 區域立委候選人: 5 位 (曹純明, 蕭嘉豪, 蕭美琴, 許願神, 黃啓嘉)
- ✅ 區域立委選舉人數G: 17132

### 2016 年花蓮縣選舉資料
- ✅ 總統候選人: 3 位
- ✅ 區域立委候選人: 4 位 (包含楊悟空)

### 2024 年花蓮縣選舉資料
- ✅ 總統候選人: 3 位
- ✅ 區域立委候選人: 23 位 (完整)

## 技術細節

### 修改的檔案
1. `main.py`:
   - `repair_president_data()` 函數 (lines 430-640) - 完全重寫
   - 花蓮縣處理參數 (lines 826-834) - city_code 修正
   - elprof 欄位對應修正 (lines 567-584)

2. `processors/format_converter.py`:
   - `format_generic_data()` 函數 (lines 267-340) - 添加格式檢測
   - `add_cols()` 函數 (lines 390-520) - 支援雙格式

### 關鍵修復點
1. **elprof.csv 欄位對應**: 從錯誤的 column[5-12] 修正為 column[6-11, 16-17]
2. **地名映射來源**: 從不存在的 villmap.csv 改為從 elbase.csv 動態建立
3. **投開票所聚合**: 新增 groupby 邏輯將 514 筆投開票所資料聚合到 176 個村里
4. **候選人資料讀取**: 從不存在的 candlist.csv 改為從 elcand.csv 讀取並組合正副總統配對
5. **格式轉換兼容**: 支援標準格式和 pivot 格式的自動檢測和處理

## 後續維護建議
1. 其他縣市如果出現類似問題,可以參考花蓮縣的修復方法
2. 總統資料的處理邏輯已經統一化,可以套用到其他縣市
3. 建議對所有縣市進行統計公式驗證 (A + B = C)
